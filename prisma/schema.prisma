// Prisma schema generated for the Oysters platform
// MySQL datasource with domain-specific models and enums

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  ADMIN
  COURIER
  STAFF
}

enum ProductCategory {
  OYSTERS
  SEA_URCHINS
  SCALLOPS
  CAVIAR
  SHRIMP
  STURGEON
  OTHER
}

enum ProductStatus {
  AVAILABLE
  PREORDER
  SOON
  HIDDEN
}

enum DeliverySlot {
  MORNING
  DAY
  EVENING
}

// –ß–∞—Å–æ–≤—ã–µ —Ç–∞–π–º-—Å–ª–æ—Ç—ã –¥–ª—è —Ç–æ—á–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –±—É–¥—É—â–µ–≥–æ)
enum HourlySlot {
  H08_09
  H09_10
  H10_11
  H11_12
  H12_13
  H13_14
  H14_15
  H15_16
  H16_17
  H17_18
  H18_19
  H19_20
  H20_21
}

enum PaymentMethod {
  CASH
  ONLINE
}

enum OrderStatus {
  NEW
  CONFIRMED
  PREP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum PromoType {
  PERCENTAGE
  FIXED
}

model User {
  id           String   @id @default(cuid())
  name         String
  phone        String   @unique
  email        String?  @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(CLIENT)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  orders            Order[]            @relation("CustomerOrders")
  courierOrders     Order[]            @relation("CourierAssignments")
  courierRoutes     CourierRoute[]     @relation("CourierRoutes")
  clientProfile     Client?
  courierProfile    CourierProfile?
  pushSubscriptions PushSubscription[]

  @@map("users")
}

model Product {
  id               String          @id @default(cuid())
  name             String
  slug             String          @unique
  category         ProductCategory
  imageUrls        Json            @map("image_urls")
  price            Decimal         @db.Decimal(12, 2) // MySQL DECIMAL(12,2)
  unit             String
  shortDescription String?         @map("short_description")
  fullDescription  String?         @map("full_description")
  status           ProductStatus   @default(AVAILABLE)
  displayOrder     Int             @default(0) @map("display_order")
  nutritionInfo    Json?           @map("nutrition_info")
  pairing          Json?
  isPromoted       Boolean         @default(false) @map("is_promoted")
  hasVariants      Boolean         @default(false) @map("has_variants")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  orderItems     OrderItem[]
  waitlist       Waitlist[]
  drops          ProductDrop[] // DEPRECATED: use Supply system instead
  supplyItems    SupplyItem[]
  supplyWaitlist SupplyWaitlist[]
  variants       ProductVariant[]

  @@map("products")
}

model ProductVariant {
  id           String        @id @default(cuid())
  productId    String        @map("product_id")
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  name         String        // "‚Ññ1", "‚Ññ2", "‚Ññ3", etc.
  size         String?       // "50-60–≥", "60-70–≥", etc.
  price        Decimal       @db.Decimal(12, 2)
  stock        Int           @default(0)
  status       ProductStatus @default(AVAILABLE)
  isAvailable  Boolean       @default(true) @map("is_available")
  displayOrder Int           @default(0) @map("display_order")

  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  @@index([productId])
  @@map("product_variants")
}

model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique @map("order_number")
  userId            String?       @map("user_id")
  courierId         String?       @map("courier_id")
  promoCodeId       String?       @map("promo_code_id")
  dropId            String?       @map("drop_id")
  items             Json
  totalAmount       Decimal       @map("total_amount") @db.Decimal(12, 2)
  deliveryStreet    String        @map("delivery_street")
  deliveryHouse     String        @map("delivery_house")
  deliveryFlat      String?       @map("delivery_flat")
  deliveryPorch     String?       @map("delivery_porch")
  deliveryFloor     String?       @map("delivery_floor")
  deliveryComment   String?       @map("delivery_comment")
  deliveryDate      DateTime      @map("delivery_date")
  slot              DeliverySlot  @map("delivery_slot")
  hourlySlot        String?       @map("hourly_slot") // –î–ª—è –±—É–¥—É—â–∏—Ö —á–∞—Å–æ–≤—ã—Ö —Å–ª–æ—Ç–æ–≤
  paymentMethod     PaymentMethod @map("payment_method")
  status            OrderStatus   @default(NEW)
  history           Json          @map("history")
  feedbackScore     Int?          @map("feedback_score")
  feedbackText      String?       @map("feedback_text")
  notifyBeforeHours Int?          @default(1) @map("notify_before_hours") // –ó–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —É–≤–µ–¥–æ–º–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  user         User?          @relation("CustomerOrders", fields: [userId], references: [id], onDelete: SetNull)
  courier      User?          @relation("CourierAssignments", fields: [courierId], references: [id], onDelete: SetNull)
  promoCode    PromoCode?     @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  drop         ProductDrop?   @relation(fields: [dropId], references: [id], onDelete: SetNull)
  orderHistory OrderHistory[]
  orderItems   OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(12, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model OrderHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  changedBy String      @map("changed_by")
  oldStatus OrderStatus @map("old_status")
  newStatus OrderStatus @map("new_status")
  timestamp DateTime    @default(now())
  comment   String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_history")
}

model Client {
  id          String   @id @default(cuid())
  userId      String?  @unique @map("user_id")
  name        String
  phone       String   @unique
  email       String?
  ordersCount Int      @default(0) @map("orders_count")
  tags        Json     @default("[]") // –ú–∞—Å—Å–∏–≤ —Ç–µ–≥–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
  createdAt   DateTime @default(now()) @map("created_at")

  user     User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  waitlist Waitlist[]

  @@map("clients")
}

model Banner {
  id           String   @id @default(cuid())
  imageUrl     String   @map("image_url")
  title        String
  subtitle     String?
  buttonText   String?  @map("button_text")
  buttonLink   String?  @map("button_link")
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("banners")
}

model Waitlist {
  id                String        @id @default(cuid())
  productId         String        @map("product_id")
  dropId            String?       @map("drop_id") // –°–≤—è–∑—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥—Ä–æ–ø–æ–º
  clientId          String?       @map("client_id")
  clientName        String        @map("client_name")
  phone             String
  email             String?
  quantity          Int           @map("qty")
  preferredDate     DateTime?     @map("preferred_date") // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
  preferredSlot     DeliverySlot? @map("preferred_slot") // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Å–ª–æ—Ç
  notifyBeforeHours Int?          @default(1) @map("notify_before_hours") // –ó–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —É–≤–µ–¥–æ–º–∏—Ç—å
  notified          Boolean       @default(false)
  autoOrderCreated  Boolean       @default(false) @map("auto_order_created") // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ –ø—Ä–∏ –¥—Ä–æ–ø–µ
  createdAt         DateTime      @default(now()) @map("created_at")

  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  drop    ProductDrop? @relation(fields: [dropId], references: [id], onDelete: SetNull)
  client  Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@map("waitlist")
}

model CourierProfile {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  rating        Decimal? @db.Decimal(3, 2)
  currentOrders Int      @default(0) @map("current_orders")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("couriers")
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  type        PromoType
  value       Decimal   @db.Decimal(8, 2)
  expiresAt   DateTime  @map("expires_at")
  maxUses     Int?      @map("max_uses")
  currentUses Int       @default(0) @map("current_uses")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  orders Order[]

  @@map("promo_codes")
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value Json

  @@map("settings")
}

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  keys      Json
  userId    String?
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("push_subscriptions")
}

// –ú–æ–¥–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—Ä–æ–ø–∞–º–∏ (–¥–∞—Ç–∞–º–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞)
model ProductDrop {
  id        String   @id @default(cuid())
  productId String   @map("product_id")
  dropDate  DateTime @map("drop_date") // –î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
  quantity  Int? // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –¥—Ä–æ–ø–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product  Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  orders   Order[]
  waitlist Waitlist[]

  @@map("product_drops")
}

// –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ –º–∞—Ä—à—Ä—É—Ç—ã –∫—É—Ä—å–µ—Ä–∞
model CourierRoute {
  id        String   @id @default(cuid())
  courierId String   @map("courier_id")
  routeDate DateTime @map("route_date")
  orderIds  Json     @map("order_ids") // –ú–∞—Å—Å–∏–≤ ID –∑–∞–∫–∞–∑–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
  routeData Json?    @map("route_data") // –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –ø–æ—Ä—è–¥–æ–∫ –∏ —Ç.–¥.)
  status    String   @default("planned") // planned, active, completed
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  courier User @relation("CourierRoutes", fields: [courierId], references: [id], onDelete: Cascade)

  @@map("courier_routes")
}

// ============================================
// SUPPLY SYSTEM (New multi-product drops)
// ============================================

// –ü–æ—Å—Ç–∞–≤–∫–∞ (Supply) - —Å–æ–±—ã—Ç–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
model Supply {
  id          String   @id @default(cuid())
  name        String // "–ü–æ—Å—Ç–∞–≤–∫–∞ –º–æ—Ä—Å–∫–∏—Ö –¥–µ–ª–∏–∫–∞—Ç–µ—Å–æ–≤"
  description String?  @db.Text
  supplyDate  DateTime @map("supply_date") // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
  isActive    Boolean  @default(true) @map("is_active")
  bannerImage String?  @map("banner_image") // URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  items    SupplyItem[]
  waitlist SupplyWaitlist[]

  @@map("supplies")
}

// –¢–æ–≤–∞—Ä –≤ –ø–æ—Å—Ç–∞–≤–∫–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
model SupplyItem {
  id          String @id @default(cuid())
  supplyId    String @map("supply_id")
  productId   String @map("product_id")
  quantity    Int // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø–æ—Å—Ç–∞–≤–∫–µ
  reservedQty Int    @default(0) @map("reserved_qty") // –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –≤ waitlist

  supply  Supply  @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([supplyId, productId])
  @@map("supply_items")
}

// –õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏ (—Å –≤—ã–±–æ—Ä–æ–º —Ç–æ–≤–∞—Ä–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ç–∞–π–º—Å–ª–æ—Ç–∞)
model SupplyWaitlist {
  id               String   @id @default(cuid())
  supplyId         String   @map("supply_id")
  productId        String   @map("product_id")
  clientName       String   @map("client_name")
  phone            String
  email            String?
  deliveryAddress  String   @map("delivery_address") @db.VarChar(500)
  quantity         Int
  deliveryDate     DateTime @map("delivery_date") // –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (supplyDate + 0-2 –¥–Ω—è)
  deliveryTimeSlot String   @map("delivery_time_slot") // "09:00-10:00", "10:00-11:00" –∏ —Ç.–¥.
  notified         Boolean  @default(false)
  orderCreated     Boolean  @default(false) @map("order_created")
  createdAt        DateTime @default(now()) @map("created_at")

  supply  Supply  @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("supply_waitlist")
}

// –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π
model PageView {
  id        String   @id @default(cuid())
  path      String
  userAgent String?  @map("user_agent") @db.Text
  ip        String?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([path])
  @@map("page_views")
}

// ============================================
// MAS: Multi-Agent System for omni-channel
// ============================================

enum MessageChannel {
  TELEGRAM
  WHATSAPP
  VK
  INSTAGRAM
  SITE
}

enum MessageDirection {
  IN
  OUT
}

// –°–≤—è–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –≤ –µ–¥–∏–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
model CustomerIdentity {
  id                String         @id @default(cuid())
  unifiedCustomerId String         @map("unified_customer_id") // –û–±—â–∏–π ID –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
  channel           MessageChannel
  externalId        String         @map("external_id") // ID –≤ –∫–∞–Ω–∞–ª–µ (telegram user id, wa phone hash, etc)
  phone             String?
  email             String?
  createdAt         DateTime       @default(now()) @map("created_at")

  @@unique([channel, externalId])
  @@index([phone])
  @@index([email])
  @@index([unifiedCustomerId])
  @@map("customer_identities")
}

// –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
model AgentMessage {
  id           String           @id @default(cuid())
  channel      MessageChannel
  customerId   String           @map("customer_id") // unified_customer_id
  direction    MessageDirection
  text         String           @db.Text
  toolCalls    Json?            @map("tool_calls")
  llmModel     String?          @map("llm_model")
  latencyMs    Int?             @map("latency_ms")
  tokensUsed   Int?             @map("tokens_used")
  feedback     Int? // 1 = üëç, -1 = üëé
  stateVersion String?          @map("state_version")
  messageId    String?          @map("message_id") // –î–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  createdAt    DateTime         @default(now()) @map("created_at")

  @@index([customerId, createdAt])
  @@index([feedback, createdAt])
  @@map("agent_messages")
}
